<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Pomodoro</title>
    <style>
     #tomato {
       width: 400px;
       height: 400px;
       display: table;
       margin: 0 auto;
     }
     #start_timers {
       display: table;
       margin: 0 auto;
     }
     #stop_timers {
       display: table;
       margin: 0 auto;
     }
     #history {
       display: table;
       margin: 0 auto;
       margin-top: 40px;
     }
     input {
       background-color: #FFF5F0;
       padding: 5px 10px;
       margin-left: 10px;
       font-family: Calibri, sans-serif;
       font-size: 20px;
       border: 1px solid #CCC;
       border-radius: 5px;
       color: darkred;
     }
     table {
       font-family: "Lucida Sans", sans-serif;
       font-size: 16px;
       border-collapse: collapse;
     }
     table td {
       padding: 10px 20px;
       border: 1px solid #CCC;
     }
    </style>
  </head>
  <body onload="init()">
    <div id="start_timers">
      <input type="button" value="25 Minutes" onclick="startPomodoro(25*60)">
      <input type="button" value="5 Minute break" onclick="startBreak(5*60)">
      <input type="button" value="1 hour break" onclick="startBreak(60*60)">
    </div>
    <canvas id="tomato"></canvas>
    <div id="stop_timers">
      <input type="button" value="stop" onclick="stopTimer()">
      <input type="button" value="reset" onclick="clearHistory()">
    </div>
    <table id="history"></table>
    <script>
     var timer;
     var tomatoImage = new Image();
     tomatoImage.src = 'tomato.png';

     function init() {
       var history = loadHistory();
       drawHistory(history);
       var canvas = document.getElementById('tomato');
       canvas.width = canvas.clientWidth;
       canvas.height = canvas.clientHeight;
       if (localStorage['pomodoroStart'] && localStorage['pomodoroEnd']) {
         timer = window.setInterval(pomodoroCallback, 50);
       } else if (localStorage['breakStart'] && localStorage['breakEnd']) {
         timer = window.setInterval(breakCallback, 50);
       } else {
         drawTomato(0, 0);
       }
     }

     function loadHistory() {
       if (localStorage['pomodoroHistory']) {
         return JSON.parse(localStorage['pomodoroHistory']);
       } else {
         return [];
       }
     }

     function saveHistory(history) {
       localStorage['pomodoroHistory'] = JSON.stringify(history);
     }

     function clearHistory() {
       localStorage['pomodoroHistory'] = [];
       localStorage.removeItem('pomodoroStart');
       localStorage.removeItem('pomodoroEnd');
       localStorage.removeItem('breakStart');
       localStorage.removeItem('breakEnd');
       drawHistory([]);
       drawTomato(0, 0);
     }

     function drawHistory(history) {
       var table = document.getElementById('history');
       while (table.firstChild) {
         table.removeChild(table.firstChild);
       }
       for (var row in history) {
         var tr = document.createElement('tr');
         // when
         var td = document.createElement('td');
         var date = new Date(history[row].time).toLocaleString();
         var text = document.createTextNode(date);
         td.appendChild(text);
         tr.appendChild(td);
         // type of record
         var td = document.createElement('td');
         var name = history[row].name;
         var text = document.createTextNode(name);
         td.appendChild(text);
         tr.appendChild(td);
         // duration
         var td = document.createElement('td');
         var duration = formatTime(history[row].duration);
         var text = document.createTextNode(duration);
         td.appendChild(text);
         tr.appendChild(td);
         // percent completed
         var td = document.createElement('td');
         var percent = Math.floor(history[row].duration / history[row].planned * 100);
         var text = document.createTextNode(percent.toFixed() + " %");
         td.appendChild(text);
         tr.appendChild(td);
         table.appendChild(tr);
       }
     }

     function drawTomato(pomodoroTime, breakTime) {
       var canvas = document.getElementById('tomato');
       var context = canvas.getContext('2d');
       var width = context.canvas.width;
       var height = context.canvas.height;
       var centerX = 200;
       var centerY = 250;
       context.clearRect(0, 0, width, height);

       context.drawImage(tomatoImage, 0, 0);

       var text = formatTime(pomodoroTime);
       context.fillStyle = "white";
       context.font = 'bold 20pt Calibri';
       var textSize = context.measureText(text);
       context.fillText(text, centerX-textSize.width/2, centerY-15);

       if (breakTime > 0) {
         context.fillStyle = "rgba(255, 255, 255, 0.9)";
         context.fillRoundedRect(width*0.2, height*0.4,
                                 width*0.6, height*0.2, 10);
         context.stroke();
         context.fillStyle = "black";
         var text = "Pause: " + formatTime(breakTime);
         context.font = '24pt Calibri';
         var textSize = context.measureText(text);
         context.fillText(text, width/2-textSize.width/2, height/2+10);
       }
     }

     CanvasRenderingContext2D.prototype.fillRoundedRect = function (x, y, w, h, radius) {
       this.beginPath();
       this.moveTo(x, y+h/2);
       this.arcTo(x, y+h, x+w/2, y+h, radius);
       this.arcTo(x+w, y+h, x+w, y+h/2, radius);
       this.arcTo(x+w, y, x+w/2, y, radius);
       this.arcTo(x, y, x, y+h/2, radius);
       this.closePath();
       this.fill();
     }

     function zeroPad(string, length) {
       while (string.length < length) {
         string = "0" + string;
       }
       return string;
     }

     function formatTime(time) {
       var date = new Date(0, 0, 0, 0, 0, 0, time);
       if (date.getHours() > 0) {
         return zeroPad(date.getHours().toFixed(), 2) + ':' +
                zeroPad(date.getMinutes().toFixed(), 2) + ':' +
                zeroPad(date.getSeconds().toFixed(), 2);
       } else {
         return zeroPad(date.getMinutes().toFixed(), 2) + ':' +
                zeroPad(date.getSeconds().toFixed(), 2);
       }
     }

     function startBreak(seconds) {
       stopTimer();
       var startTime = Date.now();
       var endTime = startTime + seconds*1000;
       localStorage['breakStart'] = startTime;
       localStorage['breakEnd'] = endTime;
       timer = window.setInterval(breakCallback, 50);
     }

     function breakCallback() {
       var breakEnd = localStorage['breakEnd'];
       if (breakEnd === null) {
         window.clearInterval(timer);
         return
       }
       var remainingTime = Math.floor((breakEnd - Date.now()));
       if (remainingTime > 0) {
         drawTomato(0, remainingTime);
       } else {
         stopTimer();
       }
     }

     function stopBreak() {
       window.clearInterval(timer);
       var breakStart = localStorage['breakStart'];
       var breakEnd = Date.now();
       var plannedBreakEnd = localStorage['breakEnd'];
       var history = loadHistory();
       history.push({name: 'Break',
                     duration: breakEnd-breakStart,
                     planned: plannedBreakEnd-breakStart,
                     time: breakEnd});
       saveHistory(history);
       drawHistory(history);
       localStorage.removeItem('breakStart');
       localStorage.removeItem('breakEnd');
       drawTomato(0, 0);
     }

     function startPomodoro(seconds) {
       stopTimer();
       var startTime = Date.now();
       var endTime = startTime + seconds*1000;
       localStorage['pomodoroStart'] = startTime;
       localStorage['pomodoroEnd'] = endTime;
       timer = window.setInterval(pomodoroCallback, 50);
     }

     function pomodoroCallback() {
       var pomodoroEnd = localStorage['pomodoroEnd'];
       if (pomodoroEnd === null) {
         window.clearInterval(timer);
         return
       }
       var remainingTime = Math.floor((pomodoroEnd - Date.now()));
       if (remainingTime > 0) {
         drawTomato(remainingTime, 0);
       } else {
         stopTimer();
       }
     }

     function stopPomodoro() {
       window.clearInterval(timer);
       var pomodoroStart = localStorage['pomodoroStart'];
       var pomodoroEnd = Date.now();
       var plannedPomodoroEnd = localStorage['pomodoroEnd'];
       var history = loadHistory();
       history.push({name: 'Pomodoro',
                     duration: pomodoroEnd-pomodoroStart,
                     planned: plannedPomodoroEnd-pomodoroStart,
                     time: pomodoroEnd});
       saveHistory(history);
       drawHistory(history);
       localStorage.removeItem('pomodoroStart');
       localStorage.removeItem('pomodoroEnd');
       drawTomato(0, 0);
     }

     function stopTimer() {
       clearInterval(timer)
       if (localStorage['pomodoroStart'] && localStorage['pomodoroEnd']) {
         stopPomodoro();
       } else if (localStorage['breakStart'] && localStorage['breakEnd']) {
         stopBreak();
       }
     }

    </script>
  </body>
</html>
